{% extends 'base.html' %}
{% load humanize %}

{% block title %}Dashboard | {{ SHOP_NAME }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="page-title-box d-sm-flex align-items-center justify-content-between">
            <h4 class="mb-sm-0">Dashboard</h4>
            <div class="page-title-right">
                <ol class="breadcrumb m-0">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
                    <li class="breadcrumb-item active">Dashboard</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row">
    <div class="col-xl-3 col-md-6">
        <a href="{% url 'sale_list' %}" class="text-decoration-none">
            <div class="card card-animate">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <p class="text-uppercase fw-medium text-muted mb-0">Today's Sales</p>
                        </div>
                    </div>
                    <div class="d-flex align-items-end justify-content-between mt-4">
                        <div>
                            <h4 class="fs-22 fw-semibold mb-4"><span class="counter-value" data-target="{{ total_sales_today }}">{{ CURRENCY_SYMBOL }}{{ total_sales_today|floatformat:2|intcomma }}</span></h4>
                            <span class="text-primary">View Sales <i class="las la-arrow-right"></i></span>
                        </div>
                        <div class="avatar-sm flex-shrink-0">
                            <span class="avatar-title bg-primary-subtle rounded fs-3">
                                <i class="las la-shopping-cart text-primary"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>

    <div class="col-xl-3 col-md-6">
        <a href="{% url 'sales_report' %}" class="text-decoration-none">
            <div class="card card-animate">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <p class="text-uppercase fw-medium text-muted mb-0">Monthly Sales</p>
                        </div>
                    </div>
                    <div class="d-flex align-items-end justify-content-between mt-4">
                        <div>
                            <h4 class="fs-22 fw-semibold mb-4"><span class="counter-value" data-target="{{ total_sales_month }}">{{ CURRENCY_SYMBOL }}{{ total_sales_month|floatformat:2|intcomma }}</span></h4>
                            <span class="text-success">View Report <i class="las la-arrow-right"></i></span>
                        </div>
                        <div class="avatar-sm flex-shrink-0">
                            <span class="avatar-title bg-success-subtle rounded fs-3">
                                <i class="las la-chart-line text-success"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>

    <div class="col-xl-3 col-md-6">
        <a href="{% url 'profit_report' %}" class="text-decoration-none">
            <div class="card card-animate">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <p class="text-uppercase fw-medium text-muted mb-0">Monthly Profit</p>
                        </div>
                    </div>
                    <div class="d-flex align-items-end justify-content-between mt-4">
                        <div>
                            <h4 class="fs-22 fw-semibold mb-4"><span class="counter-value" data-target="{{ profit_month }}">{{ CURRENCY_SYMBOL }}{{ profit_month|floatformat:2|intcomma }}</span></h4>
                            <span class="text-info">View Report <i class="las la-arrow-right"></i></span>
                        </div>
                        <div class="avatar-sm flex-shrink-0">
                            <span class="avatar-title bg-info-subtle rounded fs-3">
                                <i class="las la-money-bill-wave text-info"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>

    <div class="col-xl-3 col-md-6">
        <a href="{% url 'customer_report' %}" class="text-decoration-none">
            <div class="card card-animate">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <p class="text-uppercase fw-medium text-muted mb-0">Outstanding Dues</p>
                        </div>
                    </div>
                    <div class="d-flex align-items-end justify-content-between mt-4">
                        <div>
                            <h4 class="fs-22 fw-semibold mb-4 text-danger">{{ CURRENCY_SYMBOL }}{{ total_dues|floatformat:2|intcomma }}</h4>
                            <span class="text-danger">View Dues <i class="las la-arrow-right"></i></span>
                        </div>
                        <div class="avatar-sm flex-shrink-0">
                            <span class="avatar-title bg-danger-subtle rounded fs-3">
                                <i class="las la-exclamation-triangle text-danger"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
</div>

<!-- Second Row Stats -->
<div class="row">
    <div class="col-xl-3 col-md-6">
        <a href="{% url 'product_list' %}" class="text-decoration-none">
            <div class="card card-animate">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <p class="fw-medium text-muted mb-0">Total Products</p>
                            <h2 class="mt-4 ff-secondary fw-semibold"><span class="counter-value" data-target="{{ total_products }}">{{ total_products }}</span></h2>
                        </div>
                        <div>
                            <div class="avatar-sm flex-shrink-0">
                                <span class="avatar-title bg-secondary-subtle rounded-circle fs-2">
                                    <i class="las la-box text-secondary"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <a href="{% url 'stock_report' %}?stock_filter=low" class="text-decoration-none">
            <div class="card card-animate">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <p class="fw-medium text-muted mb-0">Low Stock Items</p>
                            <h2 class="mt-4 ff-secondary fw-semibold {% if low_stock_products > 0 %}text-warning{% endif %}"><span class="counter-value" data-target="{{ low_stock_products }}">{{ low_stock_products }}</span></h2>
                        </div>
                        <div>
                            <div class="avatar-sm flex-shrink-0">
                                <span class="avatar-title bg-warning-subtle rounded-circle fs-2">
                                    <i class="las la-exclamation-circle text-warning"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <a href="{% url 'customer_list' %}" class="text-decoration-none">
            <div class="card card-animate">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <p class="fw-medium text-muted mb-0">Total Customers</p>
                            <h2 class="mt-4 ff-secondary fw-semibold"><span class="counter-value" data-target="{{ total_customers }}">{{ total_customers }}</span></h2>
                        </div>
                        <div>
                            <div class="avatar-sm flex-shrink-0">
                                <span class="avatar-title bg-primary-subtle rounded-circle fs-2">
                                    <i class="las la-users text-primary"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card">
            <div class="card-body">
                <div class="d-flex gap-2">
                    <a href="{% url 'sale_create' %}" class="btn btn-primary flex-grow-1">
                        <i class="las la-plus"></i> New Sale
                    </a>
                    <a href="{% url 'batch_create' %}" class="btn btn-success flex-grow-1">
                        <i class="las la-plus"></i> Stock In
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sales Chart Row -->
<div class="row">
    <div class="col-xl-8">
        <div class="card">
            <div class="card-header border-0 align-items-center d-flex">
                <h4 class="card-title mb-0 flex-grow-1">Sales & Profit Trend</h4>
                <div class="flex-shrink-0">
                    <a href="{% url 'sales_report' %}" class="btn btn-soft-primary btn-sm">View Report</a>
                </div>
            </div>
            <div class="card-body pt-0">
                <div id="sales-chart" data-colors='["--in-primary", "--in-success"]' class="apex-charts" dir="ltr"></div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-4">
        <div class="card">
            <div class="card-header border-0">
                <h4 class="card-title mb-0">Payment Status</h4>
            </div>
            <div class="card-body pt-0">
                <div id="payment-status-chart" data-colors='["--in-success", "--in-warning", "--in-danger"]' class="apex-charts" dir="ltr"></div>
                <div class="mt-3">
                    <div class="d-flex justify-content-between border-bottom pb-2 mb-2">
                        <span><i class="las la-circle text-success me-1"></i> Paid</span>
                        <span class="fw-medium" id="paid-count">0</span>
                    </div>
                    <div class="d-flex justify-content-between border-bottom pb-2 mb-2">
                        <span><i class="las la-circle text-warning me-1"></i> Partial</span>
                        <span class="fw-medium" id="partial-count">0</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span><i class="las la-circle text-danger me-1"></i> Unpaid</span>
                        <span class="fw-medium" id="unpaid-count">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Recent Sales -->
    <div class="col-xl-8">
        <div class="card">
            <div class="card-header align-items-center d-flex">
                <h4 class="card-title mb-0 flex-grow-1">Recent Sales</h4>
                <div class="flex-shrink-0">
                    <a href="{% url 'sale_list' %}" class="btn btn-soft-primary btn-sm">View All</a>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-borderless table-centered align-middle mb-0">
                        <thead class="text-muted table-light">
                            <tr>
                                <th>Invoice</th>
                                <th>Customer</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sale in recent_sales %}
                            <tr>
                                <td><a href="{% url 'sale_detail' sale.pk %}" class="fw-medium">{{ sale.invoice_number }}</a></td>
                                <td>{{ sale.customer.name|default:"Walk-in" }}</td>
                                <td>{{ sale.sale_date|date:"M d, Y" }}</td>
                                <td>{{ CURRENCY_SYMBOL }}{{ sale.total_amount|floatformat:2 }}</td>
                                <td>
                                    {% if sale.payment_status == 'paid' %}
                                    <span class="badge bg-success-subtle text-success">Paid</span>
                                    {% elif sale.payment_status == 'partial' %}
                                    <span class="badge bg-warning-subtle text-warning">Partial</span>
                                    {% else %}
                                    <span class="badge bg-danger-subtle text-danger">Unpaid</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-muted">No recent sales</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Low Stock Alerts -->
    <div class="col-xl-4">
        <div class="card">
            <div class="card-header align-items-center d-flex">
                <h4 class="card-title mb-0 flex-grow-1">Low Stock Alerts</h4>
                <div class="flex-shrink-0">
                    <a href="{% url 'stock_report' %}?stock_filter=low" class="btn btn-soft-warning btn-sm">View All</a>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-borderless table-sm align-middle mb-0">
                        <thead class="text-muted table-light">
                            <tr>
                                <th>Product</th>
                                <th>Warehouse</th>
                                <th>Qty</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for batch in low_stock_batches %}
                            <tr>
                                <td>
                                    <a href="{% url 'product_detail' batch.product.pk %}">{{ batch.product.name|truncatechars:25 }}</a>
                                </td>
                                <td><small>{{ batch.warehouse.code }}</small></td>
                                <td>
                                    <span class="badge bg-danger">{{ batch.quantity }}</span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center text-muted">No low stock alerts</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
// Chart color helper
function getChartColorsArray(id) {
    if (document.getElementById(id)) {
        var colors = document.getElementById(id).getAttribute("data-colors");
        if (colors) {
            colors = JSON.parse(colors);
            return colors.map(function(color) {
                var c = color.replace(" ", "");
                if (c.indexOf(",") === -1) {
                    var style = getComputedStyle(document.documentElement);
                    return style.getPropertyValue(c) || c;
                }
                return c;
            });
        }
    }
    return ["#405189", "#0ab39c", "#f7b84b"];
}

// Monthly Sales Data from Django
var monthlySalesData = {{ monthly_sales|safe }};
var salesLabels = monthlySalesData.map(function(item) {
    var date = new Date(item.month);
    return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
});
var salesValues = monthlySalesData.map(function(item) {
    return parseFloat(item.total) || 0;
});

// Sales Chart
var salesChartColors = getChartColorsArray("sales-chart");
if (document.getElementById("sales-chart")) {
    var salesOptions = {
        chart: {
            height: 350,
            type: 'area',
            toolbar: { show: false },
            zoom: { enabled: false }
        },
        dataLabels: { enabled: false },
        stroke: { curve: 'smooth', width: 2 },
        series: [{
            name: 'Sales',
            data: salesValues.length ? salesValues : [0, 0, 0, 0, 0, 0]
        }],
        xaxis: {
            categories: salesLabels.length ? salesLabels : ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun']
        },
        colors: salesChartColors,
        fill: {
            type: 'gradient',
            gradient: {
                shadeIntensity: 1,
                opacityFrom: 0.4,
                opacityTo: 0.1,
                stops: [0, 90, 100]
            }
        },
        tooltip: {
            y: {
                formatter: function(val) {
                    return '{{ CURRENCY_SYMBOL }}' + val.toLocaleString();
                }
            }
        }
    };
    var salesChart = new ApexCharts(document.querySelector("#sales-chart"), salesOptions);
    salesChart.render();
}

// Payment Status Data
var paidCount = {{ paid_count|default:0 }};
var partialCount = {{ partial_count|default:0 }};
var unpaidCount = {{ unpaid_count|default:0 }};

document.getElementById('paid-count').textContent = paidCount;
document.getElementById('partial-count').textContent = partialCount;
document.getElementById('unpaid-count').textContent = unpaidCount;

// Payment Status Donut Chart
var paymentColors = getChartColorsArray("payment-status-chart");
if (document.getElementById("payment-status-chart")) {
    var paymentOptions = {
        chart: {
            height: 250,
            type: 'donut'
        },
        series: [paidCount || 1, partialCount || 0, unpaidCount || 0],
        labels: ['Paid', 'Partial', 'Unpaid'],
        colors: paymentColors,
        legend: { show: false },
        dataLabels: { enabled: false },
        plotOptions: {
            pie: {
                donut: {
                    size: '70%',
                    labels: {
                        show: true,
                        total: {
                            show: true,
                            label: 'Total',
                            formatter: function(w) {
                                return w.globals.seriesTotals.reduce((a, b) => a + b, 0);
                            }
                        }
                    }
                }
            }
        }
    };
    var paymentChart = new ApexCharts(document.querySelector("#payment-status-chart"), paymentOptions);
    paymentChart.render();
}
</script>
{% endblock %}
