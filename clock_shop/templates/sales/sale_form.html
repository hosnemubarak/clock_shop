{% extends 'base.html' %}

{% block title %}New Sale | {{ SHOP_NAME }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="page-title-box d-sm-flex align-items-center justify-content-between">
            <h4 class="mb-sm-0">New Sale</h4>
        </div>
    </div>
</div>

<form method="post" id="saleForm">
    {% csrf_token %}
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Sale Items</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table align-middle" id="itemsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Product</th>
                                    <th>Batch</th>
                                    <th width="80">Qty</th>
                                    <th width="120">Price</th>
                                    <th width="120">Total</th>
                                    <th width="50"></th>
                                </tr>
                            </thead>
                            <tbody id="itemsBody">
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="4" class="text-end fw-bold">Subtotal:</td>
                                    <td class="fw-bold" id="subtotal">{{ CURRENCY_SYMBOL }}0.00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <hr>
                    
                    <!-- Toggle between inventory and custom product -->
                    <div class="card bg-light-subtle border">
                        <div class="card-header border-bottom-0 pb-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="card-title mb-0"><i class="las la-plus-circle me-1"></i> Add Item</h6>
                                <ul class="nav nav-pills nav-sm" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link active" data-bs-toggle="tab" href="#inventoryTab" role="tab" onclick="toggleItemType('inventory')">
                                            <i class="las la-boxes me-1"></i> From Inventory
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" data-bs-toggle="tab" href="#customTab" role="tab" onclick="toggleItemType('custom')">
                                            <i class="las la-edit me-1"></i> Custom Entry
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="card-body pt-3">
                            <div class="tab-content">
                                <!-- Inventory Item Form -->
                                <div class="tab-pane active" id="inventoryTab" role="tabpanel">
                                    <div id="inventoryItemForm">
                                        <div class="row g-3 align-items-end">
                                            <div class="col-md-4">
                                                <label class="form-label fw-medium">Product <span class="text-danger">*</span></label>
                                                <select class="form-select" id="newProduct">
                                                    <option value="">Search or select product...</option>
                                                    {% for p in products %}
                                                    <option value="{{ p.id }}" data-name="{{ p.name }}" data-price="{{ p.default_selling_price }}">{{ p.name }} ({{ p.total_stock }} in stock)</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label fw-medium">Batch <span class="text-danger">*</span></label>
                                                <select class="form-select" id="newBatch">
                                                    <option value="">Select Batch</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2 col-6">
                                                <label class="form-label fw-medium">Qty</label>
                                                <input type="number" class="form-control" id="newQty" min="1" value="1">
                                            </div>
                                            <div class="col-md-2 col-6">
                                                <label class="form-label fw-medium">Price</label>
                                                <div class="input-group">
                                                    <span class="input-group-text">{{ CURRENCY_SYMBOL }}</span>
                                                    <input type="number" class="form-control" id="newPrice" step="0.01">
                                                </div>
                                            </div>
                                            <div class="col-md-1">
                                                <button type="button" class="btn btn-primary w-100" onclick="addItem()">
                                                    <i class="las la-plus fs-18"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div id="batchInfo" class="mt-2 small"></div>
                                    </div>
                                </div>

                                <!-- Custom Item Form -->
                                <div class="tab-pane" id="customTab" role="tabpanel">
                                    <div id="customItemForm">
                                        <div class="alert alert-soft-info border-0 mb-3" role="alert">
                                            <i class="las la-info-circle me-2"></i>
                                            Use this for <strong>old dues</strong>, <strong>legacy items</strong>, or <strong>one-time entries</strong> not in inventory.
                                        </div>
                                        <div class="row g-3 align-items-end">
                                            <div class="col-md-5">
                                                <label class="form-label fw-medium">Description <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="customDescription" placeholder="e.g., Old dues, Previous balance...">
                                            </div>
                                            <div class="col-md-2 col-4">
                                                <label class="form-label fw-medium">Qty</label>
                                                <input type="number" class="form-control" id="customQty" min="1" value="1">
                                            </div>
                                            <div class="col-md-3 col-8">
                                                <label class="form-label fw-medium">Price <span class="text-danger">*</span></label>
                                                <div class="input-group">
                                                    <span class="input-group-text">{{ CURRENCY_SYMBOL }}</span>
                                                    <input type="number" class="form-control" id="customPrice" step="0.01" placeholder="0.00">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <button type="button" class="btn btn-warning w-100" onclick="addCustomItem()">
                                                    <i class="las la-plus me-1"></i> Add
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Sale Details</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Customer</label>
                        {{ form.customer }}
                        <small class="text-muted">Leave empty for walk-in customer</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Sale Date</label>
                        {{ form.sale_date }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Discount</label>
                        {{ form.discount_amount }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tax</label>
                        {{ form.tax_amount }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        {{ form.notes }}
                    </div>
                    
                    <hr>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span id="summarySubtotal">{{ CURRENCY_SYMBOL }}0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Discount:</span>
                        <span id="summaryDiscount">{{ CURRENCY_SYMBOL }}0.00</span>
                    </div>
                    <div class="d-flex justify-content-between fw-bold fs-5">
                        <span>Total:</span>
                        <span id="summaryTotal">{{ CURRENCY_SYMBOL }}0.00</span>
                    </div>
                    
                    <hr>
                    <button type="submit" class="btn btn-success w-100 btn-lg">
                        <i class="las la-check"></i> Complete Sale
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
let items = [];
let itemIndex = 0;
let batchesData = {};
let productSelect = null;
let batchSelect = null;
let customerSelect = null;

// Initialize Tom Select for searchable dropdowns
document.addEventListener('DOMContentLoaded', function() {
    // Product dropdown
    productSelect = new TomSelect('#newProduct', {
        placeholder: 'Search or select product...',
        allowEmptyOption: true,
        onChange: function(value) {
            loadBatches(value);
        }
    });
    
    // Batch dropdown
    batchSelect = new TomSelect('#newBatch', {
        placeholder: 'Select batch...',
        allowEmptyOption: true,
        onChange: function(value) {
            updateBatchInfo(value);
        }
    });
    
    // Customer dropdown (if exists)
    const customerEl = document.querySelector('[name="customer"]');
    if (customerEl && customerEl.tagName === 'SELECT') {
        customerSelect = new TomSelect(customerEl, {
            placeholder: 'Search customer...',
            allowEmptyOption: true
        });
    }
});

// Toggle between inventory and custom item forms (Bootstrap tabs handle visibility)
function toggleItemType(type) {
    // Additional logic can be added here if needed
    // Bootstrap tabs handle the visibility automatically
}

function loadBatches(productId) {
    const priceInput = document.getElementById('newPrice');
    
    // Clear batch dropdown
    batchSelect.clear();
    batchSelect.clearOptions();
    batchSelect.addOption({value: '', text: 'Select Batch'});
    document.getElementById('batchInfo').innerHTML = '';
    
    if (!productId) return;
    
    // Get product option data
    const productOption = document.querySelector(`#newProduct option[value="${productId}"]`);
    if (productOption) {
        priceInput.value = productOption.dataset.price;
    }
    
    fetch(`/sales/api/products/${productId}/`)
        .then(response => response.json())
        .then(data => {
            batchesData = {};
            data.batches.forEach(batch => {
                batchesData[batch.id] = batch;
                batchSelect.addOption({
                    value: batch.id,
                    text: `${batch.batch_number} - ${batch.warehouse} (${batch.quantity} avail) @ {{ CURRENCY_SYMBOL }}${batch.buy_price}`
                });
            });
            batchSelect.refreshOptions(false);
        });
}

function updateBatchInfo(batchId) {
    const info = document.getElementById('batchInfo');
    
    if (batchId && batchesData[batchId]) {
        const batch = batchesData[batchId];
        info.innerHTML = `<i class="las la-info-circle"></i> Available: ${batch.quantity} units | Cost: {{ CURRENCY_SYMBOL }}${batch.buy_price} | Purchased: ${batch.purchase_date}`;
    } else {
        info.innerHTML = '';
    }
}

function addItem() {
    const productId = productSelect.getValue();
    const batchId = batchSelect.getValue();
    const qty = parseInt(document.getElementById('newQty').value);
    const price = parseFloat(document.getElementById('newPrice').value);
    
    if (!productId) {
        showValidationModal('Please select a product first.', 'Product Required');
        return;
    }
    
    if (!batchId) {
        showValidationModal('Please select a batch for this product.', 'Batch Required');
        return;
    }
    
    if (!qty || qty < 1) {
        showValidationModal('Please enter a valid quantity greater than zero.', 'Invalid Quantity');
        return;
    }
    
    if (!price || price <= 0) {
        showValidationModal('Please enter a valid selling price.', 'Invalid Price');
        return;
    }
    
    const batch = batchesData[batchId];
    if (qty > batch.quantity) {
        showValidationModal(`Only ${batch.quantity} units available in this batch. Please reduce the quantity.`, 'Insufficient Stock');
        return;
    }
    
    const productOption = document.querySelector(`#newProduct option[value="${productId}"]`);
    
    const item = {
        index: itemIndex++,
        product_id: productId,
        product_name: productOption.dataset.name,
        batch_id: batchId,
        batch_number: batch.batch_number,
        quantity: qty,
        unit_price: price,
        discount: 0,
        is_custom: false
    };
    
    items.push(item);
    
    // Update available quantity in batch data
    batchesData[batchId].quantity -= qty;
    
    renderItems();
    
    // Reset using Tom Select
    productSelect.clear();
    batchSelect.clear();
    batchSelect.clearOptions();
    batchSelect.addOption({value: '', text: 'Select Batch'});
    document.getElementById('newQty').value = '1';
    document.getElementById('newPrice').value = '';
    document.getElementById('batchInfo').innerHTML = '';
}

function addCustomItem() {
    const description = document.getElementById('customDescription').value.trim();
    const qty = parseInt(document.getElementById('customQty').value);
    const price = parseFloat(document.getElementById('customPrice').value);
    
    if (!description) {
        showValidationModal('Please enter a description for the custom item.', 'Description Required');
        return;
    }
    
    if (!qty || qty < 1) {
        showValidationModal('Please enter a valid quantity.', 'Invalid Quantity');
        return;
    }
    
    if (!price || price <= 0) {
        showValidationModal('Please enter a valid price.', 'Invalid Price');
        return;
    }
    
    const item = {
        index: itemIndex++,
        product_id: null,
        product_name: description,
        batch_id: null,
        batch_number: 'CUSTOM',
        quantity: qty,
        unit_price: price,
        discount: 0,
        is_custom: true
    };
    
    items.push(item);
    renderItems();
    
    // Reset custom form
    document.getElementById('customDescription').value = '';
    document.getElementById('customQty').value = '1';
    document.getElementById('customPrice').value = '';
}

function removeItem(index) {
    const item = items.find(i => i.index === index);
    if (item && !item.is_custom && item.batch_id && batchesData[item.batch_id]) {
        batchesData[item.batch_id].quantity += item.quantity;
    }
    items = items.filter(i => i.index !== index);
    renderItems();
}

function renderItems() {
    const tbody = document.getElementById('itemsBody');
    let html = '';
    let subtotal = 0;
    
    items.forEach(item => {
        const lineTotal = item.quantity * item.unit_price;
        subtotal += lineTotal;
        const batchBadge = item.is_custom 
            ? '<span class="badge bg-warning-subtle text-warning">CUSTOM</span>' 
            : `<code>${escapeHtml(item.batch_number)}</code>`;
        const rowClass = item.is_custom ? 'table-warning' : '';
        // Properly escape JSON for HTML attribute
        const itemJson = JSON.stringify(item).replace(/&/g, '&amp;').replace(/'/g, '&#39;').replace(/"/g, '&quot;');
        html += `
            <tr class="${rowClass}">
                <td>${escapeHtml(item.product_name)}</td>
                <td>${batchBadge}</td>
                <td>${item.quantity}</td>
                <td>{{ CURRENCY_SYMBOL }}${item.unit_price.toFixed(2)}</td>
                <td>{{ CURRENCY_SYMBOL }}${lineTotal.toFixed(2)}</td>
                <td>
                    <button type="button" class="btn btn-soft-danger btn-sm" onclick="removeItem(${item.index})">
                        <i class="las la-times"></i>
                    </button>
                </td>
                <input type="hidden" name="items" value="${itemJson}">
            </tr>
        `;
    });
    
    tbody.innerHTML = html || '<tr><td colspan="6" class="text-center text-muted">No items added</td></tr>';
    document.getElementById('subtotal').textContent = '{{ CURRENCY_SYMBOL }}' + subtotal.toFixed(2);
    document.getElementById('summarySubtotal').textContent = '{{ CURRENCY_SYMBOL }}' + subtotal.toFixed(2);
    
    updateTotals();
}

// Helper function to escape HTML entities
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function updateTotals() {
    let subtotal = 0;
    items.forEach(item => {
        subtotal += item.quantity * item.unit_price;
    });
    
    const discount = parseFloat(document.querySelector('[name="discount_amount"]').value) || 0;
    const tax = parseFloat(document.querySelector('[name="tax_amount"]').value) || 0;
    const total = subtotal - discount + tax;
    
    document.getElementById('summaryDiscount').textContent = '{{ CURRENCY_SYMBOL }}' + discount.toFixed(2);
    document.getElementById('summaryTotal').textContent = '{{ CURRENCY_SYMBOL }}' + total.toFixed(2);
}

document.querySelector('[name="discount_amount"]').addEventListener('input', updateTotals);
document.querySelector('[name="tax_amount"]').addEventListener('input', updateTotals);

document.getElementById('saleForm').addEventListener('submit', function(e) {
    if (items.length === 0) {
        e.preventDefault();
        showValidationModal('Please add at least one item to the sale before completing.', 'No Items Added');
        return false;
    }
});
</script>
{% endblock %}
