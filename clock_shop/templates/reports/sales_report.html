{% extends 'base.html' %}
{% load humanize %}

{% block title %}Sales Report | {{ SHOP_NAME }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="page-title-box d-sm-flex align-items-center justify-content-between">
            <h4 class="mb-sm-0">Sales Report</h4>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <form method="get" class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">From</label>
                        <input type="date" name="date_from" class="form-control" value="{{ date_from }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">To</label>
                        <input type="date" name="date_to" class="form-control" value="{{ date_to }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Group By</label>
                        <select name="group_by" class="form-select">
                            <option value="day" {% if group_by == 'day' %}selected{% endif %}>Day</option>
                            <option value="week" {% if group_by == 'week' %}selected{% endif %}>Week</option>
                            <option value="month" {% if group_by == 'month' %}selected{% endif %}>Month</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary w-100">Generate</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-xl-3 col-md-6">
        <div class="card card-animate">
            <div class="card-body">
                <p class="text-uppercase fw-medium text-muted mb-0">Total Sales</p>
                <h4 class="fs-22 fw-semibold mt-4">{{ CURRENCY_SYMBOL }}{{ summary.total_sales|floatformat:2|intcomma|default:"0.00" }}</h4>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card card-animate">
            <div class="card-body">
                <p class="text-uppercase fw-medium text-muted mb-0">Total Cost</p>
                <h4 class="fs-22 fw-semibold mt-4">{{ CURRENCY_SYMBOL }}{{ summary.total_cost|floatformat:2|intcomma|default:"0.00" }}</h4>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card card-animate">
            <div class="card-body">
                <p class="text-uppercase fw-medium text-muted mb-0">Total Profit</p>
                <h4 class="fs-22 fw-semibold mt-4 text-success">{{ CURRENCY_SYMBOL }}{{ summary.total_profit|floatformat:2|intcomma|default:"0.00" }}</h4>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card card-animate">
            <div class="card-body">
                <p class="text-uppercase fw-medium text-muted mb-0">Invoices</p>
                <h4 class="fs-22 fw-semibold mt-4">{{ summary.count|default:0 }}</h4>
            </div>
        </div>
    </div>
</div>

<!-- Sales Chart -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header border-0">
                <h5 class="card-title mb-0">Sales & Profit Trend</h5>
            </div>
            <div class="card-body pt-0">
                <div id="sales-period-chart" data-colors='["--in-primary", "--in-success"]' class="apex-charts" dir="ltr"></div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Sales by Period</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped mb-0">
                        <thead>
                            <tr>
                                <th>Period</th>
                                <th class="text-end">Sales</th>
                                <th class="text-end">Cost</th>
                                <th class="text-end">Profit</th>
                                <th class="text-center">Invoices</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in sales_by_period %}
                            <tr>
                                <td>{{ row.period|date:"M d, Y" }}</td>
                                <td class="text-end">{{ CURRENCY_SYMBOL }}{{ row.total|floatformat:2 }}</td>
                                <td class="text-end">{{ CURRENCY_SYMBOL }}{{ row.cost|floatformat:2 }}</td>
                                <td class="text-end text-success">{{ CURRENCY_SYMBOL }}{{ row.profit|floatformat:2 }}</td>
                                <td class="text-center">{{ row.count }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="5" class="text-center text-muted">No data</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Top Selling Products</h5>
            </div>
            <div class="card-body">
                <div id="top-products-chart" data-colors='["--in-primary"]' class="apex-charts mb-3" dir="ltr"></div>
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th class="text-center">Qty</th>
                                <th class="text-end">Revenue</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in top_products %}
                            <tr>
                                <td>{{ p.product__name|truncatechars:20 }}</td>
                                <td class="text-center">{{ p.total_quantity }}</td>
                                <td class="text-end">{{ CURRENCY_SYMBOL }}{{ p.total_revenue|floatformat:0 }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="3" class="text-center text-muted">No data</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
function getChartColorsArray(id) {
    if (document.getElementById(id)) {
        var colors = document.getElementById(id).getAttribute("data-colors");
        if (colors) {
            colors = JSON.parse(colors);
            return colors.map(function(color) {
                var c = color.replace(" ", "");
                if (c.indexOf(",") === -1) {
                    var style = getComputedStyle(document.documentElement);
                    return style.getPropertyValue(c) || c;
                }
                return c;
            });
        }
    }
    return ["#405189", "#0ab39c"];
}

// Sales Period Data
var salesPeriodLabels = [{% for row in sales_by_period %}"{{ row.period|date:'M d' }}"{% if not forloop.last %},{% endif %}{% endfor %}];
var salesPeriodValues = [{% for row in sales_by_period %}{{ row.total|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}];
var profitPeriodValues = [{% for row in sales_by_period %}{{ row.profit|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}];

// Sales Period Bar Chart
var salesChartColors = getChartColorsArray("sales-period-chart");
if (document.getElementById("sales-period-chart") && salesPeriodLabels.length > 0) {
    var options = {
        chart: {
            height: 350,
            type: 'bar',
            toolbar: { show: false }
        },
        plotOptions: {
            bar: {
                horizontal: false,
                columnWidth: '55%',
                borderRadius: 4
            }
        },
        dataLabels: { enabled: false },
        stroke: { show: true, width: 2, colors: ['transparent'] },
        series: [{
            name: 'Sales',
            data: salesPeriodValues
        }, {
            name: 'Profit',
            data: profitPeriodValues
        }],
        xaxis: { categories: salesPeriodLabels },
        colors: salesChartColors,
        fill: { opacity: 1 },
        tooltip: {
            y: {
                formatter: function(val) {
                    return '{{ CURRENCY_SYMBOL }}' + val.toLocaleString();
                }
            }
        }
    };
    var chart = new ApexCharts(document.querySelector("#sales-period-chart"), options);
    chart.render();
}

// Top Products Data
var topProductLabels = [{% for p in top_products %}"{{ p.product__name|truncatechars:15 }}"{% if not forloop.last %},{% endif %}{% endfor %}];
var topProductValues = [{% for p in top_products %}{{ p.total_revenue|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}];

// Top Products Horizontal Bar Chart
var topProductsColors = getChartColorsArray("top-products-chart");
if (document.getElementById("top-products-chart") && topProductLabels.length > 0) {
    var options2 = {
        chart: {
            height: 200,
            type: 'bar',
            toolbar: { show: false }
        },
        plotOptions: {
            bar: {
                horizontal: true,
                borderRadius: 4,
                barHeight: '70%'
            }
        },
        dataLabels: { enabled: false },
        series: [{
            name: 'Revenue',
            data: topProductValues.slice(0, 5)
        }],
        xaxis: { categories: topProductLabels.slice(0, 5) },
        colors: topProductsColors,
        tooltip: {
            y: {
                formatter: function(val) {
                    return '{{ CURRENCY_SYMBOL }}' + val.toLocaleString();
                }
            }
        }
    };
    var chart2 = new ApexCharts(document.querySelector("#top-products-chart"), options2);
    chart2.render();
}
</script>
{% endblock %}
