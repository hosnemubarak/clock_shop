{% extends 'base.html' %}
{% load humanize %}

{% block title %}Stock Report | {{ SHOP_NAME }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="page-title-box d-sm-flex align-items-center justify-content-between">
            <h4 class="mb-sm-0">Stock Report</h4>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-xl-3 col-md-6">
        <div class="card card-animate">
            <div class="card-body">
                <p class="text-uppercase fw-medium text-muted mb-0">Total Items</p>
                <h4 class="fs-22 fw-semibold mt-4">{{ totals.total_items|intcomma|default:0 }}</h4>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card card-animate">
            <div class="card-body">
                <p class="text-uppercase fw-medium text-muted mb-0">Stock Value</p>
                <h4 class="fs-22 fw-semibold mt-4">{{ CURRENCY_SYMBOL }}{{ totals.total_value|floatformat:2|intcomma|default:"0.00" }}</h4>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <form method="get" class="row g-3">
                    <div class="col-md-3">
                        <select name="warehouse" class="form-select">
                            <option value="">All Warehouses</option>
                            {% for w in warehouses %}
                            <option value="{{ w.id }}" {% if selected_warehouse == w.id|stringformat:"s" %}selected{% endif %}>{{ w.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select name="category" class="form-select">
                            <option value="">All Categories</option>
                            {% for c in categories %}
                            <option value="{{ c.id }}" {% if selected_category == c.id|stringformat:"s" %}selected{% endif %}>{{ c.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select name="stock_filter" class="form-select">
                            <option value="all">All Stock</option>
                            <option value="low" {% if stock_filter == 'low' %}selected{% endif %}>Low Stock (â‰¤10)</option>
                            <option value="out" {% if stock_filter == 'out' %}selected{% endif %}>Out of Stock</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">Filter</button>
                    </div>
                </form>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped mb-0">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>SKU</th>
                                <th>Category</th>
                                <th class="text-center">Quantity</th>
                                <th class="text-end">Avg Cost</th>
                                <th class="text-end">Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in stock_summary %}
                            <tr>
                                <td>{{ item.product__name }}</td>
                                <td><code>{{ item.product__sku }}</code></td>
                                <td>{{ item.product__category__name }}</td>
                                <td class="text-center">
                                    {% if item.total_quantity <= 10 %}
                                    <span class="badge bg-warning">{{ item.total_quantity }}</span>
                                    {% else %}
                                    <span class="badge bg-success">{{ item.total_quantity }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">{{ CURRENCY_SYMBOL }}{{ item.avg_cost|floatformat:2 }}</td>
                                <td class="text-end">{{ CURRENCY_SYMBOL }}{{ item.total_value|floatformat:2 }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="6" class="text-center text-muted">No stock data</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Stock by Warehouse</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table mb-0">
                        <thead>
                            <tr>
                                <th>Warehouse</th>
                                <th class="text-center">Items</th>
                                <th class="text-end">Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for w in stock_by_warehouse %}
                            <tr>
                                <td>{{ w.warehouse__name }}</td>
                                <td class="text-center">{{ w.total_items|intcomma }}</td>
                                <td class="text-end">{{ CURRENCY_SYMBOL }}{{ w.total_value|floatformat:2|intcomma }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Low Stock Alerts</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Warehouse</th>
                                <th class="text-center">Qty</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for b in low_stock %}
                            <tr>
                                <td>{{ b.product.name|truncatechars:25 }}</td>
                                <td>{{ b.warehouse.code }}</td>
                                <td class="text-center"><span class="badge bg-danger">{{ b.quantity }}</span></td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="3" class="text-center text-muted">No low stock</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
