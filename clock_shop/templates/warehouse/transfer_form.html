{% extends 'base.html' %}

{% block title %}New Transfer | {{ SHOP_NAME }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="page-title-box d-sm-flex align-items-center justify-content-between">
            <h4 class="mb-sm-0">New Stock Transfer</h4>
            <div class="page-title-right">
                <ol class="breadcrumb m-0">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'transfer_list' %}">Transfers</a></li>
                    <li class="breadcrumb-item active">New Transfer</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<form method="post" id="transferForm">
    {% csrf_token %}
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Transfer Items</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table align-middle" id="itemsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Product</th>
                                    <th>Batch</th>
                                    <th width="100">Qty</th>
                                    <th width="120">Cost</th>
                                    <th width="50"></th>
                                </tr>
                            </thead>
                            <tbody id="itemsBody">
                            </tbody>
                        </table>
                    </div>
                    
                    <hr>
                    <h6>Add Item</h6>
                    <p class="text-muted small">First select source warehouse to see available batches</p>
                    <div class="row g-3">
                        <div class="col-md-5">
                            <select class="form-select" id="newBatch">
                                <option value="">Select Batch</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="number" class="form-control" id="newQty" placeholder="Qty" min="1" value="1">
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-primary w-100" onclick="addItem()">
                                <i class="las la-plus"></i> Add
                            </button>
                        </div>
                    </div>
                    <div id="batchInfo" class="mt-2 text-muted small"></div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Transfer Details</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Source Warehouse <span class="text-danger">*</span></label>
                        {{ form.source_warehouse }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Destination Warehouse <span class="text-danger">*</span></label>
                        {{ form.destination_warehouse }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Transfer Date</label>
                        {{ form.transfer_date }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        {{ form.notes }}
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="las la-exchange-alt"></i> Create Transfer
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<!-- Validation Modal -->
<div class="modal fade" id="validationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning-subtle">
                <h5 class="modal-title text-warning" id="validationModalTitle">
                    <i class="las la-exclamation-triangle me-1"></i> Validation Error
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="validationModalBody">
                <!-- Message will be inserted here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    <i class="las la-check me-1"></i> OK
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const CURRENCY_SYMBOL = '{{ CURRENCY_SYMBOL }}';
let items = [];
let itemIndex = 0;
let batchesData = {};

// Validation modal helper function
function showValidationModal(message, title = 'Validation Error') {
    document.getElementById('validationModalTitle').innerHTML = `<i class="las la-exclamation-triangle me-1"></i> ${title}`;
    document.getElementById('validationModalBody').textContent = message;
    const modal = new bootstrap.Modal(document.getElementById('validationModal'));
    modal.show();
}

// Initialize source warehouse change listener
const sourceWarehouseSelect = document.querySelector('[name="source_warehouse"]');
if (sourceWarehouseSelect) {
    sourceWarehouseSelect.addEventListener('change', function() {
        loadWarehouseBatches(this.value);
        // Clear items when source warehouse changes
        items = [];
        renderItems();
    });
    
    // Load batches if a source warehouse is already selected
    if (sourceWarehouseSelect.value) {
        loadWarehouseBatches(sourceWarehouseSelect.value);
    }
}

function loadWarehouseBatches(warehouseId) {
    const batchSelect = document.getElementById('newBatch');
    batchSelect.innerHTML = '<option value="">Loading...</option>';
    batchesData = {};
    
    if (!warehouseId) {
        batchSelect.innerHTML = '<option value="">Select source warehouse first</option>';
        return;
    }
    
    fetch(`/warehouse/api/${warehouseId}/batches/`)
        .then(response => response.json())
        .then(data => {
            batchSelect.innerHTML = '<option value="">Select Batch</option>';
            if (data.length === 0) {
                batchSelect.innerHTML = '<option value="">No batches available</option>';
                return;
            }
            data.forEach(batch => {
                batchesData[batch.id] = batch;
                batchSelect.innerHTML += `<option value="${batch.id}">${batch.product_sku} - Batch: ${batch.batch_number} (${batch.quantity} avail @ ${CURRENCY_SYMBOL}${batch.buy_price})</option>`;
            });
            
            // Initialize Tom Select for searchable batch dropdown
            if (window.batchTomSelect) {
                window.batchTomSelect.destroy();
            }
            window.batchTomSelect = new TomSelect('#newBatch', {
                placeholder: 'Search batch...',
                allowEmptyOption: true
            });
        })
        .catch(error => {
            console.error('Error loading batches:', error);
            batchSelect.innerHTML = '<option value="">Error loading batches</option>';
        });
}

function addItem() {
    try {
        console.log('addItem function called');
        const batchSelect = document.getElementById('newBatch');
        const qtyInput = document.getElementById('newQty');
        const qty = parseInt(qtyInput.value);
        
        console.log('batchSelect:', batchSelect);
        console.log('window.batchTomSelect:', window.batchTomSelect);
        
        // Get batch value from Tom Select instance if it exists, otherwise from select element
        const batchValue = window.batchTomSelect ? window.batchTomSelect.getValue() : batchSelect.value;
        
        console.log('batchValue:', batchValue);
        console.log('qty:', qty);
        console.log('batchesData:', batchesData);
        
        if (!batchValue) {
            showValidationModal('Please select a batch before adding.', 'Batch Required');
            return;
        }
    
    if (!qty || qty < 1) {
        showValidationModal('Please enter a valid quantity greater than zero.', 'Invalid Quantity');
        return;
    }
    
    const batch = batchesData[batchValue];
    if (!batch) {
        showValidationModal('The selected batch is invalid. Please refresh and try again.', 'Invalid Batch');
        return;
    }
    
    if (qty > batch.quantity) {
        showValidationModal(`Only ${batch.quantity} units available in this batch. Please reduce the quantity.`, 'Insufficient Stock');
        return;
    }
    
    // Check if batch already added
    const existingItem = items.find(i => i.batch_id === batchValue);
    if (existingItem) {
        const newQty = existingItem.quantity + qty;
        if (newQty > batch.quantity + existingItem.quantity) {
            showValidationModal(`Only ${batch.quantity + existingItem.quantity} units available in this batch.`, 'Insufficient Stock');
            return;
        }
        existingItem.quantity = newQty;
    } else {
        const item = {
            index: itemIndex++,
            batch_id: batchValue,
            batch_number: batch.batch_number,
            product_name: batch.product_name,
            product_sku: batch.product_sku,
            quantity: qty,
            buy_price: batch.buy_price
        };
        items.push(item);
    }
    
    batchesData[batchValue].quantity -= qty;
    
    // Update the batch select option to show new available quantity
    if (window.batchTomSelect) {
        const b = batchesData[batchValue];
        const newText = `${b.product_sku} - Batch: ${b.batch_number} (${b.quantity} avail @ ${CURRENCY_SYMBOL}${b.buy_price})`;
        
        // Remove and re-add the option to avoid Tom Select errors
        window.batchTomSelect.removeOption(batchValue);
        window.batchTomSelect.addOption({value: batchValue, text: newText});
        window.batchTomSelect.refreshOptions(false);
    }
    
    
    console.log('Item added successfully');
    } catch (error) {
        console.error('Error in addItem:', error);
        showValidationModal('Error adding item: ' + error.message, 'Error');
    }
    renderItems();
    
    // Reset inputs
    if (window.batchTomSelect) {
        window.batchTomSelect.clear();
    } else {
        batchSelect.value = '';
    }
    qtyInput.value = '1';
}

function removeItem(index) {
    const item = items.find(i => i.index === index);
    if (item && batchesData[item.batch_id]) {
        batchesData[item.batch_id].quantity += item.quantity;
        
        // Update the batch select option
        if (window.batchTomSelect) {
            const b = batchesData[item.batch_id];
            const newText = `${b.product_sku} - Batch: ${b.batch_number} (${b.quantity} avail @ ${CURRENCY_SYMBOL}${b.buy_price})`;
            
            // Remove and re-add the option to avoid Tom Select errors
            window.batchTomSelect.removeOption(item.batch_id);
            window.batchTomSelect.addOption({value: item.batch_id, text: newText});
            window.batchTomSelect.refreshOptions(false);
        }
    }
    items = items.filter(i => i.index !== index);
    renderItems();
}

function renderItems() {
    const tbody = document.getElementById('itemsBody');
    let html = '';
    let grandTotal = 0;
    
    items.forEach(item => {
        const total = item.quantity * parseFloat(item.buy_price);
        grandTotal += total;
        html += `
            <tr>
                <td>
                    <strong>${item.product_sku}</strong>
                </td>
                <td><code>${item.batch_number}</code></td>
                <td class="text-center">${item.quantity}</td>
                <td class="text-end">${CURRENCY_SYMBOL}${total.toFixed(2)}</td>
                <td class="text-center">
                    <button type="button" class="btn btn-soft-danger btn-sm" onclick="removeItem(${item.index})">
                        <i class="las la-times"></i>
                    </button>
                </td>
                <input type="hidden" name="items" value='${JSON.stringify(item).replace(/'/g, "&#39;")}'>
            </tr>
        `;
    });
    
    if (items.length > 0) {
        html += `
            <tr class="table-light">
                <td colspan="3" class="text-end fw-bold">Total Value:</td>
                <td class="text-end fw-bold">${CURRENCY_SYMBOL}${grandTotal.toFixed(2)}</td>
                <td></td>
            </tr>
        `;
    }
    
    tbody.innerHTML = html || '<tr><td colspan="5" class="text-center text-muted py-3">No items added yet. Select a batch and quantity above.</td></tr>';
}

document.getElementById('transferForm').addEventListener('submit', function(e) {
    if (items.length === 0) {
        e.preventDefault();
        showValidationModal('Please add at least one item to the transfer before submitting.', 'No Items Added');
        return false;
    }
    
    const source = document.querySelector('[name="source_warehouse"]').value;
    const dest = document.querySelector('[name="destination_warehouse"]').value;
    
    if (!source || !dest) {
        e.preventDefault();
        showValidationModal('Please select both source and destination warehouses.', 'Warehouse Required');
        return false;
    }
    
    if (source === dest) {
        e.preventDefault();
        showValidationModal('Source and destination warehouses must be different. Please select a different destination.', 'Invalid Selection');
        return false;
    }
});

// Initial render
renderItems();
</script>
{% endblock %}
